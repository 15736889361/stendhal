<?xml version='1.0'?>
<project name="stendhal" default="compile" basedir=".">

  <property file="build.ant.properties"/>

  <!-- EDIT HERE TO CONFIGURE YOUR JAR FILE NAMES -->
  <property name="marauroa_jar" value="marauroa.jar"/>
  <property name="log4j_jar" value="log4j.jar"/>
  <property name="tiled_jar" value="tiled.jar"/>
  <!-- [END] -->
  
  <property name="marauroa" value="../marauroa/lib/${marauroa_jar}"/>
  <property name="marauroa_build" value="../marauroa/build"/>
  <property name="log4j" value="${libdir}/${log4j_jar}"/>
  <property name="classpath" value="${build};${marauroa};${log4j}"/>
  
  <property name="server_jarname" value="stendhal-server-${version}.jar"/>
  <property name="client_jarname" value="stendhal-${version}.jar"/>
  <property name="tiledplugin_jarname" value="plugin.jar"/>


  <target name="clean">
    <delete dir="${build}"/>
    <delete dir="${lib}"/>
    <delete dir="${docs}"/>
  </target>

  <target name="init">
    <mkdir dir="${build}" />
    <mkdir dir="${lib}" />
    <mkdir dir="${docs}" />
  </target>

  <target name="copy-resources" description="copies the game resources">
    <mkdir dir="${build}"/>

    <copy todir="${build}/sprites">
      <fileset dir="${sprites}"/>
    </copy>

    <copy todir="${build}/tilesets">
      <fileset dir="${tilesets}"/>
    </copy>

    <copy todir="${build}/data">
      <fileset dir="${data}"/>
    </copy>

    <copy todir="${build}/games/stendhal/server/maps">
      <fileset dir="${maps}"/>
    </copy>

    <copy todir="${build}/games/stendhal/" file="${src}/games/stendhal/log4j.properties"/>
  </target>
    
  <target name="compile" depends="init">
    <replaceregexp file="${src}/games/stendhal/client/stendhal.java"
                   match="public static final String VERSION=&quot;.*&quot;;"
                   replace="public static final String VERSION=&quot;${version}&quot;;"
                   byline="true"/>
                   
    <copy todir="${build}/sprites">
      <fileset dir="${sprites}"/>
    </copy>

    <copy todir="${build}/tilesets">
      <fileset dir="${tilesets}"/>
    </copy>

    <copy todir="${build}/data">
      <fileset dir="${data}"/>
    </copy>

    <copy todir="${build}/games/stendhal/server/maps">
      <fileset dir="${maps}"/>
    </copy>

    <copy todir="${build}/games/stendhal/server/maps">
      <fileset file="${sprites}/*.collision"/>
    </copy>

    <javac srcdir="${src}" destdir="${build}" debug="true" debuglevel="source,lines"
           includes="**/games/**" excludes="games/stendhal/tools/**">
      <classpath>
        <pathelement path="${classpath}"/>
      </classpath>
    </javac>
  </target>

  <target name="docs" depends="compile">
    <javadoc packagenames="games.stendhal.*"           
           defaultexcludes="yes"
           destdir="${docs}"
           author="true"
           version="true"
           use="true"
           classpath="${classpath}"
           windowtitle="Stendhal API Documentation Version: ${version}">
      <fileset dir="${src}">
          <include name="**/*.java"/>
      </fileset>
    </javadoc>
  </target>

  <target name="server_compile" depends="init">
    <delete dir="${build}"/>
    <mkdir dir="${build}"/>

    <copy todir="${build}/games/stendhal/server/maps">
      <fileset dir="${maps}"/>
    </copy>

    <copy todir="${build}/games/stendhal/" file="${src}/games/stendhal/log4j.properties"/>
    <copy todir="${build}/games/stendhal/" file="${src}/games/stendhal/stendhalcreateaccount.properties"/>

    <javac srcdir="${src}" destdir="${build}" debug="true" debuglevel="source,lines"
           includes="games/stendhal/server/**, games/stendhal/common/**" excludes="games/stendhal/client/**">
      <classpath>
        <pathelement path="${classpath}"/>
      </classpath>    
    </javac>
  </target>

  <target name="server_jar" depends="server_compile">
    <jar jarfile="${lib}/${server_jarname}" basedir="${build}/"/>    
  </target>

  <target name="client_compile" depends="init">
    <delete dir="${build}"/>
    <mkdir dir="${build}"/>

    <copy todir="${build}/sprites">
      <fileset dir="${sprites}"/>
    </copy>

    <copy todir="${build}/tilesets">
      <fileset dir="${tilesets}"/>
    </copy>

    <copy todir="${build}/data">
      <fileset dir="${data}">
        <exclude name="paneldrock*.jpg"/>
        <exclude name="panelmetal003.gif"/>
        <exclude name="panelrock016.jpg"/>
        <exclude name="panelwood006.jpg"/>
        <exclude name="panelwood032.gif"/>
        <exclude name="panelwood119.jpg"/>
      </fileset>
    </copy>

    <copy todir="${build}/games/stendhal/" file="${src}/games/stendhal/log4j.properties"/>

    <javac srcdir="${src}" destdir="${build}" debug="true" debuglevel="source,lines"
           includes="games/stendhal/client/**, games/stendhal/common/**" excludes="games/stendhal/server/**">
      <classpath>
        <pathelement path="${classpath}"/>
      </classpath>    
    </javac>
  </target>

  <target name="client_jar" depends="client_compile" if="marauroa_build">
    <jar jarfile="${lib}/${client_jarname}">
      <fileset dir="${build}"/>
      <fileset dir="${marauroa_build}" excludes="**/server/**"/>
      <manifest>
        <attribute name="Main-Class" value="games.stendhal.client.stendhal"/>
        <attribute name="Class-path" value="log4j.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="sign_client_jar" depends="client_jar" if="marauroa_build">
    <!--  
      <signjar jar="${lib}/${client_jarname}" alias="youralias" keystore="yourkeystore" storepass="yourpassword" />
    -->  
    <signjar jar="${lib}/${client_jarname}" alias="miguelangelblanchlardin@hotmail.com" keystore="keystore.ks" storepass="qwerty" />
    <signjar jar="${log4j}" alias="miguelangelblanchlardin@hotmail.com" keystore="keystore.ks" storepass="qwerty" />
  </target>

  <target name="jar" depends="client_jar,server_jar"/>

  <target name="release" depends="release_binary,release_source"/>
  <target name="release_binary" depends="release_server_binary,release_client_binary"/>
  
  <target name="release_server_binary" depends="server_jar">
    <mkdir dir="stendhal-server-${version}"/>
    <copy todir="stendhal-server-${version}" file="${lib}/${server_jarname}"/>
    <copy todir="stendhal-server-${version}" file="AUTHORS"/>
    <copy todir="stendhal-server-${version}" file="BUGS"/>
    <copy todir="stendhal-server-${version}" file="COPYING"/>
    <copy todir="stendhal-server-${version}" file="LICENSE"/>
    <copy todir="stendhal-server-${version}" file="README"/>
    <zip destfile="stendhal-server-${version}.zip" 
         basedir="stendhal-server-${version}"/>
    <delete dir="stendhal-server-${version}"/>
  </target>
  
  <target name="release_client_binary" depends="sign_client_jar">
    <mkdir dir="stendhal-${version}"/>
    <copy todir="stendhal-${version}" file="${log4j}"/>
    <copy todir="stendhal-${version}" file="${lib}/${client_jarname}"/>
    <copy todir="stendhal-${version}" file="AUTHORS"/>
    <copy todir="stendhal-${version}" file="BUGS"/>
    <copy todir="stendhal-${version}" file="COPYING"/>
    <copy todir="stendhal-${version}" file="LICENSE"/>
    <copy todir="stendhal-${version}" file="README"/>
    <zip destfile="stendhal-${version}.zip" 
         basedir="stendhal-${version}"/>
    <delete dir="stendhal-${version}"/>
  </target>

  <target name="release_source" depends="clean">
    <mkdir dir="stendhal-${version}"/>
    <copy todir="stendhal-${version}/src">
      <fileset dir="src"/>
    </copy>
    <copy todir="stendhal-${version}/sprites">
      <fileset dir="sprites"/>
    </copy>

    <copy todir="stendhal-${version}/tilesets">
      <fileset dir="${tilesets}"/>
    </copy>

    <copy todir="stendhal-${version}/maps">
      <fileset dir="maps"/>
    </copy>
    
    <copy todir="stendhal-${version}/data">
      <fileset dir="data"/>
    </copy>
    
    <copy todir="stendhal-${version}" file="build.xml"/>
    <copy todir="stendhal-${version}" file="AUTHORS"/>
    <copy todir="stendhal-${version}" file="BUGS"/>
    <copy todir="stendhal-${version}" file="COPYING"/>
    <copy todir="stendhal-${version}" file="LICENSE"/>
    <copy todir="stendhal-${version}" file="README"/>
  
    <tar destfile="stendhal-${version}-src.tar.gz" compression="gzip">
       <tarfileset dir="stendhal-${version}" prefix="stendhal-${version}">
         <exclude name="**/CVS/**"/>
       </tarfileset>
     </tar>

    <delete dir="stendhal-${version}"/>
  </target>
  
  <target name="convertmaps" depends="init" description="converts the *.tmx files to *.stend">
  <!-- compile the tiled plugins -->
    <javac srcdir="tiled" destdir="${build}" debug="true" debuglevel="source,lines"
           includes="tiled/plugins/stendhal/**">
      <classpath>
        <pathelement path="${classpath}"/>
        <pathelement path="${libdir}/${tiled_jar}"/>
      </classpath>
    </javac>
  <!-- compile converter class -->
    <javac srcdir="${src}" destdir="${build}" debug="true" debuglevel="source,lines"
           includes="games/stendhal/tools/MapConverter.java">
      <classpath>
        <pathelement path="${build}"/>
        <pathelement path="${libdir}/${tiled_jar}"/>
      </classpath>
    </javac>
  <!-- compile converter class -->
    <javac srcdir="${src}" destdir="${build}" debug="true" debuglevel="source,lines"
           includes="games/stendhal/tools/ImageMapConverter.java">
      <classpath>
        <pathelement path="${build}"/>
        <pathelement path="${libdir}/${tiled_jar}"/>
      </classpath>
    </javac>
      
  <!-- register taskdef -->
    <taskdef name="mapconverter" classname="games.stendhal.tools.MapConverter">
      <classpath>
        <pathelement path="${build}"/>
        <pathelement path="${libdir}/${tiled_jar}"/>
      </classpath>
    </taskdef>

  <!-- do the conversion -->
    <mkdir dir="maps/images"/>

    <mapconverter stendPath="maps" imagePath="maps/images">
    	<fileset dir="tiled/" includes="**/*.tmx" excludes ="maps"/>    	
    </mapconverter>
    </target>
    
  <target name="create_tiled_plugin" depends="init" description="creates the reader/writer-plugin jar for tiled">
  <!-- compile the plugins. Note that it enforces java 1.4 compatibility -->
    <javac srcdir="${src}" destdir="${build}" debug="true" debuglevel="source,lines" target="1.4" source="1.4"
           includes="games/stendhal/tools/tiled/*.java">
      <classpath>
        <pathelement path="${libdir}/${tiled_jar}"/>
      </classpath>
    </javac>

  <!--  create jar file -->
    <jar jarfile="${lib}/${tiledplugin_jarname}">
      <fileset dir="${build}">
        <include name="games/stendhal/tools/tiled/*.class"/>
      </fileset>
      <manifest>
        <attribute name="Reader-Class" value="games.stendhal.tools.tiled.StendhalMapReader"/>
        <attribute name="Writer-Class" value="games.stendhal.tools.tiled.StendhalMapWriter"/>
      </manifest>
    </jar>
  </target>
  
  <target name="release_tiled" depends="create_tiled_plugin" description="creates the tiled zip with all maps and the stendhal plugins">
    <mkdir dir="tiledplugin_tmp"/>
    <mkdir dir="tiledplugin_tmp/plugins"/>
    
  <!-- copy reader/writer plugins -->
    <copy todir="tiledplugin_tmp/plugins">
      <fileset file="${lib}/${tiledplugin_jarname}"/>
    </copy>
  <!-- copy README, tiled.jar, maps, tileset images -->
    <copy todir="tiledplugin_tmp">
      <fileset file="${libdir}/${tiled_jar}"/>
      <fileset file="COPYING"/>
      <fileset dir="tiled">
        <include name="*.tmx"/>
        <include name="README"/>
        <include name="README.Tiled"/>
      </fileset>
      <fileset dir="tilesets">
        <include name="*.png"/>
      </fileset>
    </copy>

    <!-- create zip file -->
    <zip destfile="${lib}/stendhal_mapeditor-${version}.zip">
      <zipfileset prefix="stendhal_mapeditor" dir="tiledplugin_tmp"/>
    </zip>
    <delete dir="tiledplugin_tmp"/>
  </target>
  
  
  
</project>